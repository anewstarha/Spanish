<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿è¯­é©¾è€ƒå­¦ä¹ ç¬”è®°</title>
    <!-- å¼•å…¥ Supabase JS åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        nav {
            display: flex;
            justify-content: center;
            background-color: #34495e;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
        }
        nav button {
            background-color: #34495e;
            color: white;
            border: none;
            padding: 12px 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.2s;
            border-radius: 5px;
            margin: 0 10px;
        }
        nav button:hover {
            background-color: #496279;
            transform: translateY(-2px);
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            resize: vertical;
            min-height: 80px;
        }
        .input-group button {
            padding: 12px 20px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .input-group button:hover {
            background-color: #27ae60;
        }
        .sentence-list-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .sentence-list-controls .select-all-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sentence-list-controls .delete-selected-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .sentence-list-controls .delete-selected-btn:hover {
            background-color: #c0392b;
        }
        .sentence-list, .word-list {
            list-style: none;
            padding: 0;
        }
        .sentence-item {
            background-color: #ecf0f1;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            transition: background-color 0.3s;
        }
        .sentence-item.mastered {
            background-color: #d4edda;
        }
        .sentence-checkbox {
            cursor: pointer;
            width: 20px;
            height: 20px;
        }
        .sentence-text {
            flex-grow: 1;
        }
        .sentence-text .spanish {
            font-weight: bold;
            font-size: 1.1em;
            display: block;
        }
        .sentence-text .chinese {
            color: #555;
            font-weight: normal;
            font-size: 0.9em;
            font-style: normal;
            display: block;
        }
        .sentence-text [contenteditable="true"] {
            border: 1px solid #3498db;
            background-color: #e8f4fd;
            padding: 5px;
            border-radius: 3px;
        }
        .sentence-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 10px;
        }
        .sentence-actions .read-btn { color: #3498db; }
        .sentence-actions .slow-read-btn { color: #f39c12; }
        .sentence-actions .word-read-btn { color: #e67e22; }
        .sentence-actions .ai-explain-btn { color: #9b59b6; } /* New AI button color */
        .sentence-actions .delete-btn { color: #e74c3c; }
        .sentence-actions .mastered-btn { color: #2ecc71; }
        .sentence-actions .edit-btn { color: #f39c12; }
        .sentence-actions .save-btn {
            color: #2ecc71;
            display: none;
        }
        .word-item {
            background-color: #ecf0f1;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .word-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .word-text-wrapper {
            flex-grow: 1;
        }
        .word-text-wrapper .spanish-word {
            font-weight: bold;
            font-size: 1.1em;
            display: block;
        }
        .word-text-wrapper .chinese-word-translation {
            color: #555;
            font-weight: normal;
            font-size: 0.9em;
            font-style: normal;
            display: block;
        }
        .word-text-wrapper [contenteditable="true"] {
            border: 1px solid #3498db;
            background-color: #e8f4fd;
            padding: 5px;
            border-radius: 3px;
        }
        .word-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 10px;
        }
        .word-actions .read-btn { color: #3498db; }
        .word-actions .edit-btn { color: #f39c12; }
        .word-actions .save-btn {
            color: #2ecc71;
            display: none;
        }
        .word-sentences-list {
            list-style: none;
            padding: 10px 0 0 0;
            margin: 10px 0 0 0;
            border-top: 1px solid #ddd;
            display: none; /* Initially hidden */
        }
        .word-sentences-list li {
            background-color: #f9f9f9;
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 5px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .word-sentences-list li .spanish-part {
            font-weight: bold;
        }
        .word-sentences-list li .chinese-part {
            color: #777;
        }
        .word-empty-message {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
        }
        h2 {
            margin-top: 40px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
        }
        /* Custom Modal styles for alerts and confirms and AI explanation */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px; /* Wider for explanations */
            text-align: left; /* Align text left for readability */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 80vh; /* Max height for scrollable content */
            overflow-y: auto; /* Enable scrolling for long explanations */
        }
        .modal-content h3 {
            margin-top: 0;
            text-align: center;
            color: #2c3e50;
        }
        .modal-content p {
            margin: 10px 0;
            line-height: 1.6;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }
        .modal-buttons .confirm-btn, .modal-buttons .close-btn {
            background-color: #3498db; /* Blue for action/close */
            color: white;
        }
        .modal-buttons .cancel-btn {
            background-color: #ccc;
        }
        .modal-content .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>è¥¿è¯­é©¾è€ƒå­¦ä¹ ç¬”è®°</h1>
        <nav>
            <button id="show-sentences-btn">å¥å­åˆ—è¡¨</button>
            <button id="show-words-btn">é«˜é¢‘è¯æ±‡</button>
        </nav>

        <!-- å¥å­é¡µé¢ -->
        <div id="sentences-page">
            <h2 id="sentences-header">æ‰€æœ‰å¥å­</h2>
            <div class="input-group">
                <label>æ‰¹é‡æ·»åŠ ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šè¥¿è¯­ [|| ä¸­æ–‡]ï¼‰</label>
                <textarea id="batch-input" placeholder="ä¾‹å¦‚:&#10;Hola, Â¿cÃ³mo estÃ¡s?&#10;Gracias, estoy bien. || è°¢è°¢ï¼Œæˆ‘å¾ˆå¥½ã€‚"></textarea>
                <button id="add-btn">æ‰¹é‡æ·»åŠ </button>
            </div>
            <div class="sentence-list-controls">
                <div class="select-all-group">
                    <input type="checkbox" id="selectAllCheckbox">
                    <label for="selectAllCheckbox">å…¨é€‰</label>
                </div>
                <button id="deleteSelectedBtn" class="delete-selected-btn">åˆ é™¤é€‰ä¸­é¡¹</button>
            </div>
            <ul class="sentence-list" id="sentence-list">
                <!-- å¥å­åˆ—è¡¨ä¼šé€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>

        <!-- é«˜é¢‘è¯é¡µé¢ -->
        <div id="words-page" style="display: none;">
            <h2>é«˜é¢‘è¯æ±‡</h2>
            <ul class="word-list" id="word-list">
                <!-- é«˜é¢‘è¯æ±‡ä¼šé€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>
    </div>

    <!-- Custom Modal for confirmations -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3>ç¡®è®¤æ“ä½œ</h3>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button id="confirmBtn" class="confirm-btn">ç¡®è®¤</button>
                <button id="cancelBtn" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- AI Explanation Modal -->
    <div id="aiExplanationModal" class="modal">
        <div class="modal-content">
            <h3 id="aiExplanationTitle">AI å¥å­è§£é‡Š</h3>
            <div id="aiExplanationContent">
                <div class="loading-spinner"></div>
                <p style="text-align: center;">AI æ­£åœ¨ç”Ÿæˆè§£é‡Šä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
            <div class="modal-buttons">
                <button id="aiExplanationCloseBtn" class="close-btn">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // === 1. Configure Supabase client ===
        const SUPABASE_URL = 'https://rvarfascuwvponxwdeoe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2YXJmYXNjdXd2cG9ueHdkZW9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNDE5MDcsImV4cCI6MjA3MTgxNzkwN30.KdBVtNYdOw9n8351FWlAgAPCv0WmSnr9vOGgtHCRSnc';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // === 2. Getting DOM elements ===
        const sentencesPage = document.getElementById('sentences-page');
        const wordsPage = document.getElementById('words-page');
        const showSentencesBtn = document.getElementById('show-sentences-btn');
        const showWordsBtn = document.getElementById('show-words-btn');
        const sentencesHeader = document.getElementById('sentences-header');
        const batchInput = document.getElementById('batch-input');
        const addBtn = document.getElementById('add-btn');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const sentenceList = document.getElementById('sentence-list');
        const wordList = document.getElementById('word-list');
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        const aiExplanationModal = document.getElementById('aiExplanationModal');
        const aiExplanationTitle = document = document.getElementById('aiExplanationTitle');
        const aiExplanationContent = document.getElementById('aiExplanationContent');
        const aiExplanationCloseBtn = document.getElementById('aiExplanationCloseBtn');


        const audio = new Audio(); // Create a single Audio object
        const commonWordsToFilter = new Set(['el', 'la', 'los', 'las', 'un', 'una', 'unos', 'unas', 'de', 'del', 'a', 'al', 'en', 'es', 'son', 'con', 'para', 'por', 'que', 'y', 'o', 'como', 'si', 'mas', 'pero', 'no', 'muy', 'mi', 'su', 'sus', 'sin', 'ni', 'hay', 'alguno', 'algunos', 'mucho', 'muchos', 'poco', 'pocos']);
        
        let allSentences = []; // Global variable to store all sentences

        // === 3. Core Functions ===

        // Function to show a specific page and hide others
        function showPage(pageId) {
            sentencesPage.style.display = 'none';
            wordsPage.style.display = 'none';
            document.getElementById(pageId).style.display = 'block';
        }

        // Custom modal for confirmations, replacing window.confirm()
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                confirmMessage.innerText = message;
                confirmModal.style.display = 'flex';
                
                const onConfirm = () => {
                    confirmModal.style.display = 'none';
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    resolve(true);
                };

                const onCancel = () => {
                    confirmModal.style.display = 'none';
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    resolve(false);
                };

                confirmBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);
            });
        }

        // Function to show the AI explanation modal
        function showAiExplanation(title, content) {
            aiExplanationTitle.innerText = title;
            aiExplanationContent.innerHTML = content;
            aiExplanationModal.style.display = 'flex';
        }

        // Function to hide the AI explanation modal
        aiExplanationCloseBtn.addEventListener('click', () => {
            aiExplanationModal.style.display = 'none';
        });
        
        // Use Google Text-to-Speech API to synthesize audio
        // Supports normal and slow modes via SSML
        async function readTextWithGoogle(text, isSlow = false) {
            const API_KEY = 'AIzaSyC_OfSDK55ECs7bk5XkNAlO5a8YEuIX2TE';
            const API_URL = `https://texttospeech.googleapis.com/v1beta1/text:synthesize?key=${API_KEY}`;
            
            if (API_KEY === 'YOUR_GOOGLE_API_KEY' || API_KEY.length === 0) {
                console.warn('Google Text-to-Speech API key is not set. TTS functionality will be disabled.');
                const errorMessage = 'è¯­éŸ³åŠŸèƒ½éœ€è¦æœ‰æ•ˆçš„ Google Text-to-Speech API å¯†é’¥æ‰èƒ½å·¥ä½œã€‚';
                showCustomConfirm(errorMessage).then(() => {});
                return;
            }

            let inputText;
            if (isSlow) {
                inputText = `<speak><prosody rate="slow">${text}</prosody></speak>`;
            } else {
                inputText = text;
            }

            const request = {
                input: isSlow ? { ssml: inputText } : { text: inputText },
                voice: { languageCode: 'es-ES', ssmlGender: 'FEMALE' },
                audioConfig: { audioEncoding: 'MP3' },
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(request),
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Google API error:', error);
                    showCustomConfirm('Google API é”™è¯¯ï¼šæ— æ³•ç”Ÿæˆè¯­éŸ³ã€‚').then(() => {});
                    return;
                }

                const data = await response.json();
                const audioContent = data.audioContent;

                audio.pause();
                audio.currentTime = 0;
                audio.src = `data:audio/mp3;base64,${audioContent}`;
                audio.play();

            } catch (error) {
                console.error('Failed to fetch from Google TTS:', error);
                showCustomConfirm('æ— æ³•è¿æ¥åˆ° Google Text-to-Speech æœåŠ¡ã€‚').then(() => {});
            }
        }
        
        // Read a sentence word by word with a delay between each word
        async function readWordByWord(sentence) {
            const words = sentence.split(/\s+/).filter(word => word.length > 0);
            
            for (let i = 0; i < words.length; i++) {
                await new Promise(resolve => {
                    readTextWithGoogle(words[i]);
                    audio.onended = () => {
                        setTimeout(resolve, 300); 
                    };
                });
            }
        }

        // Function to get AI explanation for a sentence
        async function getAiExplanation(spanishSentence) {
            const systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è¥¿ç­ç‰™è¯­è€å¸ˆã€‚è¯·ç”¨ç®€æ´æ˜äº†çš„ä¸­æ–‡ï¼Œå¯¹ä»¥ä¸‹è¥¿ç­ç‰™è¯­å¥å­è¿›è¡Œå…¨é¢çš„è¯­æ³•ã€è¯æ±‡å’Œå«ä¹‰è§£é‡Šã€‚å¦‚æœå¥å­æœ‰ç‰¹æ®Šç”¨æ³•æˆ–æ–‡åŒ–èƒŒæ™¯ï¼Œä¹Ÿè¯·ç®€è¦è¯´æ˜ã€‚è¯·é¿å…å†—ä½™çš„å®¢å¥—è¯ï¼Œç›´æ¥ç»™å‡ºè§£é‡Šã€‚`;
            // !!! åœ¨è¿™é‡Œç²˜è´´æ‚¨çš„ Google Gemini API å¯†é’¥ !!!
            // !!! è®¿é—® https://aistudio.google.com/ æˆ– https://console.cloud.google.com/apis/credentials è·å–å¯†é’¥ !!!
            const apiKey = "AIzaSyA9XOIeJFc3DXlDuuBQRLPYC-hTlJ1e14M"; 
            // !!! è¯·æ›¿æ¢ above with your actual API key !!!

            if (apiKey === "YOUR_GOOGLE_GEMINI_API_KEY_HERE" || apiKey.length === 0) {
                showAiExplanation('é”™è¯¯', `<p>è¯·å…ˆåœ¨ä»£ç ä¸­é…ç½®æ‚¨çš„ Google Gemini API å¯†é’¥ï¼</p><p>è®¿é—® <a href="https://aistudio.google.com/" target="_blank">Google AI Studio</a> æˆ– <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Platform</a> è·å–å¯†é’¥ã€‚</p>`);
                return;
            }

            const userQuery = `è¯·è§£é‡Šè¿™ä¸ªè¥¿ç­ç‰™è¯­å¥å­: "${spanishSentence}"`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            // Show loading state in the modal
            showAiExplanation('AI æ­£åœ¨ç”Ÿæˆè§£é‡Š', `<div class="loading-spinner"></div><p style="text-align: center;">AI æ­£åœ¨ç”Ÿæˆè§£é‡Šä¸­ï¼Œè¯·ç¨å€™...</p>`);

            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    console.error('Gemini API error:', errorDetails);
                    showAiExplanation('é”™è¯¯', `<p>AI è§£é‡Šç”Ÿæˆå¤±è´¥ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚</p><p>é”™è¯¯è¯¦æƒ…: ${errorDetails.error.message || 'æœªçŸ¥é”™è¯¯'}</p>`);
                    return;
                }

                const result = await response.json();
                const explanation = result.candidates?.[0]?.content?.parts?.[0]?.text || 'æœªèƒ½è·å– AI è§£é‡Šã€‚';
                
                showAiExplanation('AI å¥å­è§£é‡Š', `<p>${explanation.replace(/\n/g, '<br>')}</p>`);

            } catch (error) {
                console.error('Failed to fetch from Gemini API:', error);
                showAiExplanation('é”™è¯¯', `<p>æ— æ³•è¿æ¥åˆ° AI æœåŠ¡ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ–ç¨åå†è¯•ã€‚</p><p>é”™è¯¯è¯¦æƒ…: ${error.message}</p>`);
            }
        }
        
        // Fetches and displays high-frequency words from the database
        async function fetchAndRenderHighFrequencyWords() {
            try {
                const { data, error } = await _supabase
                    .from('high_frequency_words')
                    .select('*')
                    .order('word', { ascending: true });

                if (error) {
                    console.error('Failed to fetch high-frequency words:', error);
                    wordList.innerHTML = '<p class="word-empty-message">æ— æ³•åŠ è½½é«˜é¢‘è¯æ±‡ã€‚è¯·æ£€æŸ¥æ•°æ®åº“æƒé™æˆ–æ§åˆ¶å°é”™è¯¯ã€‚</p>';
                    return;
                }
                
                wordList.innerHTML = ''; // Clear previous words

                if (data.length === 0) {
                    wordList.innerHTML = '<p class="word-empty-message">æ²¡æœ‰é«˜é¢‘è¯æ±‡ã€‚è¯·å…ˆåœ¨â€œå¥å­åˆ—è¡¨â€é¡µé¢æ·»åŠ ä¸€äº›å¥å­ï¼</p>';
                    return;
                }

                data.forEach(word => {
                    const li = document.createElement('li');
                    li.className = 'word-item';
                    li.dataset.id = word.id;
                    li.innerHTML = `
                        <div class="word-content">
                            <div class="word-text-wrapper">
                                <span class="spanish-word" data-field="word">${word.word}</span>
                                <span class="chinese-word-translation" data-field="chinese_translation">${word.chinese_translation || 'ç‚¹å‡»ç¼–è¾‘æ·»åŠ ç¿»è¯‘'}</span>
                            </div>
                            <div class="word-actions">
                                <button class="read-btn" title="æœ—è¯»">ğŸ”Š</button>
                                <button class="edit-btn" title="ç¼–è¾‘">âœï¸</button>
                                <button class="save-btn" title="ä¿å­˜">âœ”ï¸</button>
                            </div>
                        </div>
                        <ul class="word-sentences-list"></ul>
                    `;

                    const sentencesList = li.querySelector('.word-sentences-list');
                    const wordSpan = li.querySelector('.spanish-word');
                    const translationSpan = li.querySelector('.chinese-word-translation');
                    const readBtn = li.querySelector('.read-btn');
                    const editBtn = li.querySelector('.edit-btn');
                    const saveBtn = li.querySelector('.save-btn');

                    // Event listener to toggle sentence list visibility and render sentences
                    li.querySelector('.word-content').addEventListener('click', (e) => {
                        // Avoid triggering if a button was clicked
                        if (e.target.closest('button')) {
                            return;
                        }

                        if (sentencesList.style.display === 'block') {
                            sentencesList.style.display = 'none';
                        } else {
                            renderSentencesForWord(word.word, sentencesList);
                            sentencesList.style.display = 'block';
                        }
                    });

                    // Read word button
                    readBtn.addEventListener('click', () => readTextWithGoogle(word.word));

                    // Edit button
                    editBtn.addEventListener('click', () => {
                        translationSpan.contentEditable = true;
                        translationSpan.focus();
                        editBtn.style.display = 'none';
                        saveBtn.style.display = 'inline-block';
                    });

                    // Save button
                    saveBtn.addEventListener('click', async (event) => {
                        const newTranslation = translationSpan.innerText.trim();
                        const wordId = parseInt(li.dataset.id, 10);
                        
                        await updateWordTranslation(wordId, newTranslation);

                        translationSpan.contentEditable = false;
                        editBtn.style.display = 'inline-block';
                        saveBtn.style.display = 'none';
                    });

                    wordList.appendChild(li);
                });
            } catch (err) {
                console.error('Error in fetchAndRenderHighFrequencyWords:', err);
                wordList.innerHTML = '<p class="word-empty-message">åŠ è½½é«˜é¢‘è¯æ±‡æ—¶å‘ç”Ÿé”™è¯¯ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°ã€‚</p>';
            }
        }

        // Update a word's translation in the database
        async function updateWordTranslation(id, newTranslation) {
            const { error } = await _supabase
                .from('high_frequency_words')
                .update({ chinese_translation: newTranslation })
                .eq('id', id);

            if (error) {
                console.error('Supabase update error:', error);
                showCustomConfirm(`ä¿å­˜å¤±è´¥ï¼š${error.message}`).then(() => {});
            } else {
                showCustomConfirm('ç¿»è¯‘ä¿å­˜æˆåŠŸï¼').then(() => {});
            }
        }
        
        // Renders sentences related to a specific word
        function renderSentencesForWord(word, sentencesListElement) {
            sentencesListElement.innerHTML = ''; // Clear previous sentences
            
            const filteredSentences = allSentences.filter(s => 
                s.spanish_text.toLowerCase().includes(word.toLowerCase())
            );
            
            if (filteredSentences.length === 0) {
                const li = document.createElement('li');
                li.innerText = 'æ²¡æœ‰æ‰¾åˆ°åŒ…å«è¯¥å•è¯çš„å¥å­ã€‚';
                li.style.fontStyle = 'italic';
                sentencesListElement.appendChild(li);
                return;
            }

            filteredSentences.forEach(sentence => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div>
                        <span class="spanish-part">${sentence.spanish_text}</span>
                        <span class="chinese-part">${sentence.chinese_translation}</span>
                    </div>
                    <div>
                        <button class="read-btn" title="æœ—è¯»">ğŸ”Š</button>
                    </div>
                `;
                li.querySelector('.read-btn').addEventListener('click', () => readTextWithGoogle(sentence.spanish_text));
                sentencesListElement.appendChild(li);
            });
        }
        
        // Master function to recalculate and save high-frequency words
        async function recalculateAndSaveHighFrequencyWords() {
            // Step 1: Fetch all sentences to get the latest data
            const { data: sentences, error: fetchError } = await _supabase
                .from('sentences')
                .select('*');

            if (fetchError) {
                console.error('Failed to fetch sentences for word recalculation:', fetchError);
                return;
            }

            // Step 2: Clear the existing high-frequency words table
            const { error: deleteError } = await _supabase
                .from('high_frequency_words')
                .delete()
                .gt('id', 0); // Deletes all rows where id > 0

            if (deleteError) {
                console.error('Failed to clear high-frequency words:', deleteError);
                return;
            }

            // Step 3: Recalculate word frequencies and prepare the new list
            const wordCounts = new Map();
            sentences.forEach(sentence => {
                const words = sentence.spanish_text.toLowerCase().split(/[\s,.;:!?Â¿Â¡"â€œâ€()\[\]]+/u).filter(word => word.length > 0);
                words.forEach(word => {
                    if (!commonWordsToFilter.has(word)) {
                        wordCounts.set(word, (wordCounts.get(word) || 0) + 1);
                    }
                });
            });

            const topWords = Array.from(wordCounts.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);

            const wordsToInsert = topWords.map(([word, count]) => ({
                word: word,
                chinese_translation: '' // Default translation is now an empty string
            }));

            // Step 4: Insert the new, updated list of words
            if (wordsToInsert.length > 0) {
                const { error: insertError } = await _supabase
                    .from('high_frequency_words')
                    .insert(wordsToInsert);
                
                if (insertError) {
                    console.error('Failed to save new high-frequency words:', insertError);
                }
            }
            
            // Re-render the word list page if it's currently visible
            if (wordsPage.style.display === 'block') {
                 fetchAndRenderHighFrequencyWords();
            }
        }
        
        // Fetch and display all sentences
        async function fetchSentences() {
            const { data, error } = await _supabase
                .from('sentences')
                .select('*')
                .order('id', { ascending: false });

            if (error) {
                console.error('Failed to fetch sentences:', error);
                return;
            }
            
            allSentences = data;
            renderSentences(allSentences);
        }

        // Render the list of sentences on the page
        function renderSentences(sentences, title = 'æ‰€æœ‰å¥å­') {
            sentencesHeader.innerHTML = `<h2>${title}</h2>`;
            sentenceList.innerHTML = '';
            
            if (sentences.length < allSentences.length) {
                const backBtn = document.createElement('button');
                backBtn.innerText = 'è¿”å›æ‰€æœ‰å¥å­';
                backBtn.style.cssText = 'padding: 8px 15px; margin-bottom: 10px; background-color: #7f8c8d; color: white; border: none; border-radius: 5px; cursor: pointer;';
                backBtn.addEventListener('click', () => {
                    renderSentences(allSentences);
                });
                sentencesHeader.appendChild(backBtn);
            }

            sentences.forEach(sentence => {
                const li = document.createElement('li');
                li.className = `sentence-item ${sentence.mastered ? 'mastered' : ''}`;
                li.dataset.id = sentence.id;
                
                li.innerHTML = `
                    <input type="checkbox" class="sentence-checkbox" data-id="${sentence.id}">
                    <div class="sentence-text">
                        <span class="spanish" data-field="spanish_text">${sentence.spanish_text}</span>
                        <span class="chinese" data-field="chinese_translation">${sentence.chinese_translation}</span>
                    </div>
                    <div class="sentence-actions">
                        <button class="read-btn" title="æœ—è¯»">ğŸ”Š</button>
                        <button class="slow-read-btn" title="æ…¢é€Ÿæœ—è¯»">ğŸ¢ğŸ”Š</button>
                        <button class="word-read-btn" title="é€è¯æœ—è¯»">ğŸ¤</button>
                        <button class="ai-explain-btn" title="AI è§£é‡Š">ğŸ§ </button> <!-- New AI Explain button -->
                        <button class="mastered-btn" title="æ ‡è®°å·²æŒæ¡">${sentence.mastered ? 'âœ…' : 'â˜‘ï¸'}</button>
                        <button class="edit-btn" title="ç¼–è¾‘">âœï¸</button>
                        <button class="save-btn" title="ä¿å­˜">âœ”ï¸</button>
                        <button class="delete-btn" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                `;
                
                li.querySelector('.read-btn').addEventListener('click', () => readTextWithGoogle(sentence.spanish_text));
                li.querySelector('.slow-read-btn').addEventListener('click', () => readTextWithGoogle(sentence.spanish_text, true));
                li.querySelector('.word-read-btn').addEventListener('click', () => readWordByWord(sentence.spanish_text));
                li.querySelector('.ai-explain-btn').addEventListener('click', () => getAiExplanation(sentence.spanish_text)); // AI button event listener
                li.querySelector('.mastered-btn').addEventListener('click', () => toggleMastered(sentence.id, !sentence.mastered));
                li.querySelector('.delete-btn').addEventListener('click', () => deleteSentence(sentence.id));
                
                const editBtn = li.querySelector('.edit-btn');
                const saveBtn = li.querySelector('.save-btn');
                const spanishSpan = li.querySelector('.spanish');
                const chineseSpan = li.querySelector('.chinese');
                
                editBtn.addEventListener('click', () => {
                    spanishSpan.contentEditable = true;
                    chineseSpan.contentEditable = true;
                    spanishSpan.focus();
                    editBtn.style.display = 'none';
                    saveBtn.style.display = 'inline-block';
                });

                saveBtn.addEventListener('click', async (event) => {
                    const li = event.target.closest('.sentence-item');
                    if (!li) return;

                    const newSpanishText = spanishSpan.innerText.trim();
                    const newChineseText = chineseSpan.innerText.trim();
                    const sentenceId = parseInt(li.dataset.id, 10);
                    
                    // Step 1: å…ˆæ£€æŸ¥è¯¥IDæ˜¯å¦å­˜åœ¨äºæ•°æ®åº“
                    const { data: existingData, error: fetchError } = await _supabase
                        .from('sentences')
                        .select('id')
                        .eq('id', sentenceId)
                        .limit(1);

                    if (fetchError || !existingData || existingData.length === 0) {
                        console.error('ä¿å­˜å¤±è´¥ï¼šæ•°æ®åº“ä¸­æœªæ‰¾åˆ°è¯¥å¥å­IDã€‚');
                        showCustomConfirm('ä¿å­˜å¤±è´¥ï¼šè¯¥å¥å­å¯èƒ½å·²è¢«åˆ é™¤æˆ–ä¸å­˜åœ¨ã€‚').then(() => {});
                        spanishSpan.contentEditable = false;
                        chineseSpan.contentEditable = false;
                        editBtn.style.display = 'inline-block';
                        saveBtn.style.display = 'none';
                        return;
                    }
                    
                    // Step 2: å¦‚æœå­˜åœ¨ï¼Œå†è¿›è¡Œæ›´æ–°æ“ä½œ
                    const updates = { 
                        spanish_text: newSpanishText,
                        chinese_translation: newChineseText
                    };
                    
                    const { data: updateData, error: updateError } = await _supabase
                        .from('sentences')
                        .update(updates)
                        .eq('id', sentenceId);

                    if (updateError) {
                        console.error('Supabase æ›´æ–°é”™è¯¯:', updateError);
                        showCustomConfirm(`ä¿å­˜å¤±è´¥ï¼š${updateError.message}`).then(() => {});
                    } else {
                         showCustomConfirm('ä¿å­˜æˆåŠŸï¼').then(() => {});
                    }
                    
                    spanishSpan.contentEditable = false;
                    chineseSpan.contentEditable = false;
                    editBtn.style.display = 'inline-block';
                    saveBtn.style.display = 'none';
                });
                
                sentenceList.appendChild(li);
            });
        }
        
        async function addSentences() {
            const inputText = batchInput.value.trim();
            if (!inputText) {
                showCustomConfirm('è¾“å…¥å†…å®¹ä¸èƒ½ä¸ºç©ºï¼').then(() => {});
                return;
            }

            const lines = inputText.split('\n');
            const sentencesToProcess = [];
            let duplicateCount = 0;

            lines.forEach(line => {
                const parts = line.split('||').map(part => part.trim());
                if (parts.length > 0 && parts[0]) {
                    const spanishText = parts[0];
                    const chineseTranslation = parts.length > 1 ? parts[1] : '';
                    sentencesToProcess.push({
                        spanish_text: spanishText,
                        chinese_translation: chineseTranslation,
                        mastered: false
                    });
                }
            });

            if (sentencesToProcess.length === 0) {
                showCustomConfirm('æ²¡æœ‰æ£€æµ‹åˆ°æœ‰æ•ˆçš„å¥å­æ ¼å¼ã€‚è¯·ç¡®ä¿æ¯è¡ŒåŒ…å«è¥¿è¯­ï¼Œå¹¶å¯é€‰åœ°ä½¿ç”¨ "||" åˆ†éš”ä¸­æ–‡ã€‚').then(() => {});
                return;
            }
            
            const { data: existingSentences, error: fetchError } = await _supabase
                .from('sentences')
                .select('spanish_text');

            if (fetchError) {
                console.error('Failed to fetch existing sentences:', fetchError);
                showCustomConfirm('è·å–ç°æœ‰å¥å­å¤±è´¥ï¼Œæ— æ³•æ£€æŸ¥é‡å¤ã€‚').then(() => {});
                return;
            }
            
            const existingTextSet = new Set(existingSentences.map(s => s.spanish_text));
            const sentencesToAdd = [];

            sentencesToProcess.forEach(s => {
                if (existingTextSet.has(s.spanish_text)) {
                    duplicateCount++;
                } else {
                    sentencesToAdd.push(s);
                }
            });

            if (sentencesToAdd.length > 0) {
                const { error } = await _supabase
                    .from('sentences')
                    .insert(sentencesToAdd);
                
                if (error) {
                    console.error('Failed to add sentences:', error);
                    showCustomConfirm('æ‰¹é‡æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°äº†è§£è¯¦æƒ…ã€‚').then(() => {});
                    return;
                }
            }
            
            await recalculateAndSaveHighFrequencyWords();

            batchInput.value = '';

            let message = '';
            if (sentencesToAdd.length > 0) {
                message += `æˆåŠŸæ·»åŠ äº† ${sentencesToAdd.length} æ¡æ–°å¥å­ã€‚`;
            }
            if (duplicateCount > 0) {
                if (message) message += '\n';
                message += `å…¶ä¸­æœ‰ ${duplicateCount} æ¡å¥å­æ˜¯é‡å¤çš„ï¼Œå› æ­¤æœªè¢«æ·»åŠ ã€‚`;
            }
            if (message) {
                showCustomConfirm(message).then(() => {});
            }
        }
        
        async function deleteSentence(id) {
            const confirmed = await showCustomConfirm('ä½ ç¡®å®šè¦åˆ é™¤è¿™æ¡å¥å­å—ï¼Ÿ');
            if (confirmed) {
                const { error } = await _supabase
                    .from('sentences')
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error('Failed to delete:', error);
                    showCustomConfirm('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°äº†è§£è¯¦æƒ…ã€‚').then(() => {});
                } else {
                    await recalculateAndSaveHighFrequencyWords();
                }
            }
        }

        async function deleteSelectedSentences() {
            const checkedBoxes = document.querySelectorAll('.sentence-checkbox:checked');
            if (checkedBoxes.length === 0) {
                showCustomConfirm('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„å¥å­ï¼').then(() => {});
                return;
            }
            
            const confirmed = await showCustomConfirm(`ä½ ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkedBoxes.length} æ¡å¥å­å—ï¼Ÿ`);
            if (!confirmed) {
                return;
            }

            const idsToDelete = Array.from(checkedBoxes).map(cb => cb.dataset.id);
            
            const { error } = await _supabase
                .from('sentences')
                .delete()
                .in('id', idsToDelete);

            if (error) {
                console.error('Failed to delete selected sentences:', error);
                showCustomConfirm('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°äº†è§£è¯¦æƒ…ã€‚').then(() => {});
            } else {
                selectAllCheckbox.checked = false;
                await recalculateAndSaveHighFrequencyWords();
            }
        }

        // Toggle the 'mastered' status
        async function toggleMastered(id, newStatus) {
            const { error } = await _supabase
                .from('sentences')
                .update({ mastered: newStatus })
                .eq('id', id);

            if (error) {
                console.error('Failed to update status:', error);
                showCustomConfirm('æ›´æ–°æŒæ¡çŠ¶æ€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°äº†è§£è¯¦æƒ…ã€‚').then(() => {});
            }
        }

        // Set up Supabase Realtime listener for all database changes
        function setupRealtimeListener() {
            _supabase.channel('public:sentences')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sentences' }, payload => {
                    fetchSentences();
                })
                .subscribe();
        }

        // === 4. Event listeners ===
        window.addEventListener('load', () => {
             fetchSentences();
             setupRealtimeListener();
             showPage('sentences-page');
        });
        
        addBtn.addEventListener('click', addSentences);
        showSentencesBtn.addEventListener('click', () => showPage('sentences-page'));
        showWordsBtn.addEventListener('click', () => {
             showPage('words-page');
             fetchAndRenderHighFrequencyWords();
        });
        selectAllCheckbox.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.sentence-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });
        deleteSelectedBtn.addEventListener('click', deleteSelectedSentences);
    </script>
</body>
</html>
